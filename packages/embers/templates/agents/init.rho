{% extends "common/insert_signed.rho" %}

{%- block name -%} agents {%- endblock -%}

{%- block initialization -%}
{%- filter indent(8) -%}

new rl(`rho:registry:lookup`),
    revAddress(`rho:rev:address`),
    devNull(`rho:io:devNull`),
    abort(`rho:execution:abort`),
    deployData(`rho:deploy:data`),
    treeHashMapCh,
    listOpsCh,
    visit
in {
    rl!(`rho:lang:treeHashMap`, *treeHashMapCh) |
    for(treeHashMap <- treeHashMapCh) {
        treeHashMap!("init", 3, *treeHashMapCh) |

        for(@map <- treeHashMapCh) {
            treeHashMapCh!(*treeHashMap, map)
        }
    } |

    rl!(`rho:lang:listOps`, *listOpsCh) |
    for(@(_, listOps) <- listOpsCh) {
        listOpsCh!(listOps)
    } |

    contract visit(@"agents", @address, f, notFound) = {
        for(treeHashMap, @map <<- treeHashMapCh) {
            treeHashMap!("getOrElse", map, address, *f, *notFound)
        }
    } |

    contract visit(@"agentVersions", @address, @id, f, notFound) = {
        new foundCh in {
            visit!("agents", address, *foundCh, *notFound) |

            for(@agents <- foundCh; treeHashMap, _ <<- treeHashMapCh) {
                treeHashMap!("getOrElse", agents, id, *f, *notFound)
            }
        }
    } |

    contract visit(@"agentVersion", @address, @id, @version, f, notFound) = {
        new foundCh in {
            visit!("agentVersions", address, id, *foundCh, *notFound) |

            for(@agentVersions <- foundCh; treeHashMap, _ <<- treeHashMapCh) {
                treeHashMap!("getOrElse", agentVersions, version, *f, *notFound)
            }
        }
    } |

    contract agents(@"create", @id, @version, @created_at, @name, @description, @shard, @logo, @code) = {
        new deployDataCh, deployerAddressCh, valueCh, nilCh, errCh in {
            deployData!(*deployDataCh) |

            for(_, @deployerId, _ <- deployDataCh) {
                revAddress!("fromDeployerId", deployerId, *deployerAddressCh)
            } |

            for(@address <- deployerAddressCh) {
                visit!("agents", address, *valueCh, *nilCh) |

                for(@agents <- valueCh; treeHashMap, _ <<- treeHashMapCh) {
                    new insertAgentCh, agentVersionsCh in {
                        treeHashMap!("getOrElse", agents, id, *errCh, *insertAgentCh) |

                        for(<- insertAgentCh) {
                            treeHashMap!("init", 3, *agentVersionsCh) |

                            for(@agentVersions <- agentVersionsCh ) {
                                treeHashMap!("set", agents, id, agentVersions, *devNull) |
                                treeHashMap!("set", agentVersions, version,
                                    {
                                        "created_at": created_at,
                                        "last_deploy": Nil,
                                        "name": name,
                                        "description": description,
                                        "shard": shard,
                                        "logo": logo,
                                        "code": code,
                                    }, *devNull) |
                                treeHashMap!("set", agentVersions, "latest",
                                    {
                                        "version": version,
                                        "created_at": created_at,
                                        "last_deploy": Nil,
                                        "name": name,
                                        "description": description,
                                        "shard": shard,
                                        "logo": logo,
                                        "code": code,
                                    }, *devNull)
                            }
                        }
                    }
                } |

                for(<- nilCh; treeHashMap, @map <<- treeHashMapCh) {
                    new agentsCh, agentVersionsCh in {
                        treeHashMap!("init", 3, *agentsCh) |
                        treeHashMap!("init", 3, *agentVersionsCh) |

                        for(@agents <- agentsCh & @agentVersions <- agentVersionsCh) {
                            treeHashMap!("set", map, address, agents, *devNull) |
                            treeHashMap!("set", agents, id, agentVersions, *devNull) |
                            treeHashMap!("set", agentVersions, version,
                                {
                                    "created_at": created_at,
                                    "last_deploy": Nil,
                                    "name": name,
                                    "description": description,
                                    "shard": shard,
                                    "logo": logo,
                                    "code": code,
                                }, *devNull) |
                            treeHashMap!("set", agentVersions, "latest",
                                {
                                    "version": version,
                                    "created_at": created_at,
                                    "last_deploy": Nil,
                                    "name": name,
                                    "description": description,
                                    "shard": shard,
                                    "logo": logo,
                                    "code": code,
                                }, *devNull)
                        }
                    }
                }
            } |

            for(<- errCh) {
                abort!("in createAiAgent")
            }
        }
    } |

    contract agents(@"list", @address, ret) = {
        new valueCh, nilCh in {
            visit!("agents", address, *valueCh, *nilCh) |

            for(@agents <- valueCh; treeHashMap, _ <<- treeHashMapCh; listOps <<- listOpsCh) {
                new toAgentHeader, agentsMapsCh in {
                    contract toAgentHeader(@(id, agentVersions), ret) = {
                        new agentLastVersionCh in {
                            treeHashMap!("get", agentVersions, "latest", *agentLastVersionCh) |
                            for(@agentLastVersion <- agentLastVersionCh) {
                                ret!(agentLastVersion.delete("code").set("id", id))
                            }
                        }
                    } |

                    treeHashMap!("toMap", agents, *agentsMapsCh) |
                    for(@agentsMaps <- agentsMapsCh) {
                        listOps!("unorderedParMap", agentsMaps.toList(), *toAgentHeader, *ret)
                    }
                }
            } |

            for(<- nilCh) {
                ret!([])
            }
        }
    } |

    contract agents(@"listVersions", @address, @id, ret) = {
        new valueCh, nilCh, agentVersionsMapCh, toAgentHeader in {
            visit!("agentVersions", address, id, *valueCh, *nilCh) |

            for(@agentVersions <- valueCh; treeHashMap, _ <<- treeHashMapCh; listOps <<- listOpsCh) {
                contract toAgentHeader(@(version, agent), ret) = {
                    ret!(agent.delete("code").union({"id": id, "version": version}))
                } |

                treeHashMap!("toMap", agentVersions, *agentVersionsMapCh) |
                for(@agentVersionsMap <- agentVersionsMapCh) {
                    listOps!("parMap", agentVersionsMap.delete("latest").toList(), *toAgentHeader, *ret)
                }
            } |

            for(<- nilCh) {
                ret!(Nil)
            }
        }
    } |

    contract agents(@"get", @address, @id, @version, ret) = {
        new valueCh, nilCh in {
            visit!("agentVersion", address, id, version, *valueCh, *nilCh) |

            for(@agentVersion <- valueCh) {
                ret!(agentVersion.union({"id": id, "version": version}))
            } |

            for(<- nilCh) {
                ret!(Nil)
            }
        }
    } |

    contract agents(@"save", @id, @version, @created_at, @name, @description, @shard, @logo, @code) = {
        new deployDataCh, deployerAddressCh, valueCh, errCh, insertAgentVersionCh in {
            deployData!(*deployDataCh) |

            for(_, @deployerId, _ <- deployDataCh) {
                revAddress!("fromDeployerId", deployerId, *deployerAddressCh)
            } |

            for(@address <- deployerAddressCh) {
                visit!("agentVersions", address, id, *valueCh, *errCh)
            } |

            for(@agentVersions <- valueCh; treeHashMap, _ <<- treeHashMapCh) {
                treeHashMap!("getOrElse", agentVersions, version, *errCh, *insertAgentVersionCh) |

                for(<- insertAgentVersionCh) {
                    treeHashMap!("set", agentVersions, version,
                        {
                            "created_at": created_at,
                            "last_deploy": Nil,
                            "name": name,
                            "description": description,
                            "shard": shard,
                            "logo": logo,
                            "code": code,
                        }, *devNull) |

                    treeHashMap!("set", agentVersions, "latest",
                        {
                            "version": version,
                            "created_at": created_at,
                            "last_deploy": Nil,
                            "name": name,
                            "description": description,
                            "shard": shard,
                            "logo": logo,
                            "code": code,
                        }, *devNull)
                }
            } |

            for(<- errCh) {
                abort!("in saveAiAgent")
            }
        }
    } |

    contract agents(@"delete", @id) = {
        new deployDataCh, deployerAddressCh, valueCh in {
            deployData!(*deployDataCh) |

            for(_, @deployerId, _ <- deployDataCh) {
                revAddress!("fromDeployerId", deployerId, *deployerAddressCh)
            } |

            for(@address <- deployerAddressCh) {
                visit!("agents", address, *valueCh, *devNull)
            } |

            for(@agents <- valueCh; treeHashMap, _ <<- treeHashMapCh) {
                treeHashMap!("delete", agents, id, *devNull)
            }
        }
    } |

    contract agents(@"recordDeploy", @id, @version, @last_deploy) = {
        new deployDataCh, deployerAddressCh, valueCh, errCh, latestCh in {
            deployData!(*deployDataCh) |

            for(_, @deployerId, _ <- deployDataCh) {
                revAddress!("fromDeployerId", deployerId, *deployerAddressCh)
            } |

            for(@address <- deployerAddressCh) {
                visit!("agentVersions", address, id, *valueCh, *errCh)
            } |

            for(@agentVersions <- valueCh; treeHashMap, _ <<- treeHashMapCh) {
                treeHashMap!("getOrElse", agentVersions, version, *valueCh, *errCh) |
                for(@agent <- valueCh) {
                    treeHashMap!("set", agentVersions, version, agent.union({"last_deploy": last_deploy}), *devNull)
                } |

                treeHashMap!("getOrElse", agentVersions, "latest", *latestCh, *errCh) |
                for(@agent <- latestCh) {
                    if(agent.get("version") == version) {
                        treeHashMap!("set", agentVersions, "latest", agent.union({"last_deploy": last_deploy}), *devNull)
                    }
                }
            } |

            for(<- errCh) {
                abort!("in recordDeployAiAgent")
            }
        }
    }
}

{%- endfilter -%}
{%- endblock -%}
